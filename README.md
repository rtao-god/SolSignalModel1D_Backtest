# SolSignalModel1D_Backtest

Дневной (24h) предсказатель для **SOLUSDT**, который запускается утром по NY и пытается сказать, что будет к этому же времени через сутки:

- `0` — **обвал**
- `1` — **боковик**
- `2` — **рост**
- и, если это боковик, ещё микро-направление: **БоковикРост** / **БоковикОбвал**

Модель заточена под реальный рынок SOL: чаще всего день узкий, поэтому боковик — отдельный класс, а не ошибка модели.

---

## Что делает проект

1. **тянет 6h-свечи** с Binance по SOL, BTC (и опционально PAXG)
2. **строит дневные строки** (`RowBuilder.cs`): ретёрны, волатильность, ATR, FNG, DXY, RSI, адаптивный `minMove`, флаги режима
3. **в каждом роллинговом окне**:
   - берёт последние N дней как train
   - берёт следующие M дней как test
   - тренирует модели
   - прогоняет тест
   - печатает метрики и 3 последние тестовые дни с ценами и фактом
4. **выводит две метрики**:
   - `base acc` — точность “кто из 0/1/2”
   - `micro acc` — точность с учётом микро-доворотов боковика (то, что нужно для торговли)

---

## Архитектура модели

Модель сейчас **двухступенчатая**.

### 1. Stage 1 — есть ли ход
LightGBM (binary): смотрит на фичи и решает “день поедет или нет” относительно адаптивного `minMove`.

- если **поедет** → идём в классификатор направления
- если **не поедет** → идём в микро-классификатор по плоскому

### 2. Stage 2a — направление при движении
Две модели (normal / down), потому что SOL в просадке ведёт себя иначе. Выбор по флагу `RegimeDown` из строки. Выход: `Обвал` или `Рост`.

### 3. Stage 2b — микро при боковике
Если Stage 1 сказала “движения нет”, запускаем микро-модель, которая обучена **только** на действительно плоских днях:

- факт: `|ret24h| < minMove`
- но внутри дня есть сдвиг ≥ `0.1 * minMove` (ты это в `RowBuilder` уже сделал)

Выход:  
- `БоковикРост`
- `БоковикОбвал`
- или “молчу”, если уверенности мало (`prob < 0.60`)

---

## Фичи (основа из `RowBuilder.cs`)

- SOL returns: 1, 3, 30 (6h-свечей)
- BTC returns: 1, 3, 30 — фон/лид
- `sol30 - btc30` — отрыв SOL от BTC
- ATR(14) в %, динамическая вола по 6h
- адаптивный `minMove` = max(ATR, локальная вола) × месячный коэффициент, с кэпами
- RSI по SOL (храним как `RsiCentered = RSI - 50`)
- BTC vs SMA200
- FNG, DXY change, золото (если есть)
- флаги режимов: `RegimeDown`, `HardRegime`

---

## Что выводит `Program.cs`

Для каждого окна:

```text
[roll] train: 2024-10-05 .. 2025-06-02 (272)
[roll] test : 2025-06-02 .. 2025-08-01 (36)
[roll] base acc: 69.4% (25/36)
[roll] micro acc: 72.2% (26/36)


А потом 3 последние тестовые даты в человекочитаемом виде:
[dbg-day] 2025-09-27 08:00Z
  entry=152.35  maxHigh24=153.10  minLow24=150.90  fwdClose24=152.80
  rsi:52.3  atr:1.25%  minMove:1.10%
  Прогноз:Боковик  Микро:БоковикРост  Факт:БоковикРост  (reason:2stage:flat+microUp)