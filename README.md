# SolSignalModel1D_Backtest

Бэктест дневной модели для рынка SOL, работающей в фиксированной точке времени (NY 12:00) и пытающейся предсказать, что произойдёт с ценой в следующие 24 часа: обвал, боковик или рост. Модель использует 2-ступенчатую схему и отдельную “микро”-ветку для боковиков, чтобы извлекать пользу из дней с небольшим, но направленным движением.

Проект умеет:
- скачивать 6h и 1h свечи с Binance;
- собирать дневные строки с индикаторами (RSI, ATR, ретурны, DXY, Fear & Greed и др.);
- обучать одну 2-ступенчатую ML-модель (`move` → `dir`) + бинарную модель для микро-боковиков;
- катать rolling-бэктест;
- считать классификационные и торговые метрики;
- проверять внутри дня (по 1h) что было раньше — TP или SL;
- выводить последние дни для ручного контроля.

---

## 1. Идея модели

Цель — принять решение в один момент времени (NY 12:00) и понять, стоит ли вообще лезть в рынок и в какую сторону.

Модель работает в таком порядке:

1. **Move-модель**: будет ли за сутки движение больше некоего адаптивного порога `minMove`.
2. **Если движение будет** — в каком направлении (рост / обвал), с учётом “режима” рынка.
3. **Если движения нет** — это боковик. Для боковика есть отдельная микро-модель, которая пытается определить наклон: вверх (боковикРост) или вниз (боковикОбвал).

Адаптивный `minMove` рассчитывается от ATR/волатильности и не даёт размечать слишком “узкие” дни.

---

## 2. Разметка классов

На каждый день есть фактический суточный ретурн `solFwd1` (12:00 → 12:00). Дальше:

| Факт | Условие | Класс |
|------|---------|-------|
| Обвал | `solFwd1 <= -minMove` | `0` |
| Боковик | `-minMove < solFwd1 < +minMove` | `1` |
| Рост | `solFwd1 >= +minMove` | `2` |

Для боковика дополнительно помечается “микро”:

- **FactMicroUp**: `abs(solFwd1) < minMove && solFwd1 >= 0.1 * minMove`
- **FactMicroDown**: `abs(solFwd1) < minMove && solFwd1 <= -0.1 * minMove`

Это те самые боковики со смещением, которые можно торговать как “почти рост” или “почти обвал”.

---

## 3. Результат последнего бэктеста

По данным, которые уже были прогнаны.

### 3.1 Классификация (строгая)

```text
total tested: 695
accuracy: 54.1%
macro F1: 45.4%, micro F1: 54.1%

class | support | precision% | recall% | f1%
    0 |    151 |        39.0 |    27.2 | 32.0
    1 |    381 |        60.9 |    73.5 | 66.6
    2 |    163 |        42.3 |    33.7 | 37.5

Выводы:

класс 1 (боковик) — самый частый и самый предсказуемый;

классы 0 и 2 (обвал/рост) реже и сложнее: recall ~27–34%;

accuracy ~54% на трёхклассовой задаче — нормальный уровень для такого разметчика.

3.2 “Мягкая” точность (direction-aware)

Часть дней на практике надо считать “угаданными”, даже если модель дала рост, а фактически был боковикРост. Для этого используется “мягкая” метрика:

lenient acc: 62.2% (432/695)


То есть если предсказан рост, а день был “боковик, но вверх” — засчитывается успех. Это ближе к реальному трейдингу.

3.3 Торговля без стоп-лоссов (дневная, tp-or-close, 3%)
=== Trading (tp-or-close, 3%) ===
Total PnL: 10719.9% (~x108.20)
Max DD: 13.9%
Trades (opened): 300
tp-hit overall: 72.3% (217/300)


Логика:

берётся направленный сигнал (явный рост/обвал или боковик с микро-направлением);

ставится TP 3%;

если за сутки TP задело — фиксируется 3%;

если нет — закрытие по цене через 24 часа.

Этот режим показывает, что модель в целом правильно указывает сторону: в 72% направленных сделок TP за сутки всё-таки случается. За счёт отсутствия стопов кривая сильно разрастается.

4. Что считается успехом

Для анализа удобно явно фиксировать, какие пары “прогноз → факт” считать ок:

Прогноз	Факт	Успех
Рост (2)	Рост (2)	✅
Рост (2)	БоковикРост	✅
Обвал (0)	Обвал (0)	✅
Обвал (0)	БоковикОбвал	✅
Боковик (1) + microUp	БоковикРост	✅
Боковик (1) + microDown	БоковикОбвал	✅
Боковик (1) без микро	Боковик	✅
Рост (2)	Боковик	⚠️ условно (можно заработать только по фитилю)
Обвал (0)	Боковик	⚠️ условно
Рост (2)	БоковикОбвал / Обвал	❌
Обвал (0)	БоковикРост / Рост	❌

Именно за счёт такого “ослабленного” подсчёта точность подскакивает с ~54% до ~62%.

5. Почасовые TP/SL

Для более честной проверки добавлен режим “кто первый внутри дня”: грузятся 1h свечи и для каждого дневного входа проверяется последовательность:

если в течение дня первой коснулась TP → успех;

если первой коснулась SL → провал;

если и TP, и SL внутри одной часовой свечи → помечается как “ambiguous”.

Пример результата:

=== Hourly TP/SL (who-first) ===
tp-first: 66
sl-first: 131
ambiguous (tp & sl in 1h): 3


Добавление часового стопа резко снижает прибыльность по сравнению с дневным вариантом без стопов, потому что внутри 1h цена чаще успевает “зацепить” короткий SL раньше, чем дневной TP.

6. Почему так отличается PnL со стопами и без

Сравнение двух режимов:

Режим	PnL	Макс. просадка	Сделок
Без SL (tp-or-close, 3%)	+10 719.9% (×108.2)	~13.9%	300
С почасовыми TP/SL	+20–21% (×1.2)	~17%	58–75

Разница принципиальная:

дневной режим “простительный”: TP мог случиться в любой момент дня → засчитывается;

почасовой режим “жёсткий”: если цена сначала ушла против входа на свой SL — сделка считается неудачной, даже если позже дневной ход отдал бы TP.

Это не ошибка модели, а просто другой риск-профиль.

7. Как читать метрики

accuracy — насколько часто модель угадала ровно тот класс, который был в факте;

macro F1 — среднее по всем трём классам, показывает, что боковики тянутся лучше;

lenient acc — то, что ближе к реальной торговле (считает “рост ≈ боковикРост” и т.п.);

tp-hit — насколько часто внутри суток цена успевала дать целевые 3%;

Total PnL — модельная доходность от последовательного применения сигналов;

Max DD — насколько глубоко просаживалась модельная кривая.

8. Структура проекта
Core/
  Data/           # загрузка свечей (6h, 1h), F&G, DXY, extra.json
  DataBuilder/    # RowBuilder и сборка дневных строк (DataRow)
  ML/             # ModelTrainer, ModelBundle, PredictionEngine, ML DTO
  Analytics/      # ClassificationMetrics, TradingMetrics
  Trading/        # HourlyTradeEvaluator и почасовая логика TP/SL
  Infra/          # HttpFactory, TimeZones и другие утилиты

Program.cs        # основной rolling-бэктест с выводом в консоль
README.md


Вся тяжёлая логика (метрики, трейдинг, построение строк) вынесена из Program.cs, чтобы консольный файл занимался только:

загрузкой данных,

запуском обучения,

запуском бэктеста,

выводом результата.

9. Формулы (словами)

Дневной PnL без SL:
ret = TP%, если high/low за 24ч задели TP в сторону позиции, иначе
ret = (close24 - entry) / entry или наоборот для шорта.

Hourly “кто первый”:
пройти свечи от t0 до t0+24h,
если на одной из свечей high ≥ tpPrice → tp-first,
если low ≤ slPrice → sl-first,
если и то и другое в одной свече → ambiguous.

Lenient accuracy:
обычная accuracy, но пары (Рост, БоковикРост) и (Обвал, БоковикОбвал) считаются совпадением.

10. Вывод

Модель уверенно ловит боковики и достаточную часть направленных дней.

При оценке “по-человечески” (направление важнее амплитуды) точность ~62%.

В режиме “без стопов” (tp-or-close 3%) получается очень мощная кривая, потому что модель в большинстве направленных дней даёт TP в течение суток.

В “строгом” режиме с часовыми SL результат по PnL становится реалистичным и сильно ниже — это плата за контроль риска внутри дня.