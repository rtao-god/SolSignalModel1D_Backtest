# SolSignalModel1D_Backtest

Бэктест дневной модели для рынка **SOL**, которая в фиксированное время (NY 12:00) пытается предсказать, что будет с ценой в ближайшие 24 часа: **обвал**, **боковик** или **рост**.  
Модель двухступенчатая и имеет отдельную микро-ветку для “наклонённых” боковиков — чтобы забирать дни с небольшим, но направленным движением.

Проект умеет:

- скачивать 6h и 1h свечи с Binance;
- собирать дневные строки с индикаторами (RSI, ATR, ретурны, DXY, Fear & Greed и т.п.);
- обучать 2-ступенчатую ML-схему (`move` → `dir`) + бинарную микро-модель для боковиков;
- гонять rolling-бэктест;
- считать классификационные и **торговые** метрики;
- по 1h смотреть, что внутри дня было раньше — **TP или SL**;
- выводить последние дни для ручной проверки.

---

## 1. Идея модели

Цель — в один момент времени (NY 12:00) решить:

1. вообще есть ли смысл входить;
2. если да — в какую сторону.

Порядок работы:

1. **Move-модель**: будет ли за сутки движение больше адаптивного порога `minMove` (порог от волатильности/ATR).
2. **Если движение есть** — в какую сторону (рост / обвал) с учётом “режима” рынка.
3. **Если движения нет** — это боковик. Для боковика запускается микро-модель, которая говорит: *вверх* (боковикРост) или *вниз* (боковикОбвал).

Адаптивный `minMove` нужен затем, чтобы не размечать смешные дни с очень узким диапазоном.

---

## 2. Разметка классов

Берём фактический суточный ретурн `solFwd1` (от 12:00 до 12:00 следующего дня) и размечаем:

| Факт     | Условие                      | Класс |
|----------|------------------------------|-------|
| Обвал    | `solFwd1 <= -minMove`        | `0`   |
| Боковик  | `-minMove < solFwd1 < +minMove` | `1`   |
| Рост     | `solFwd1 >= +minMove`        | `2`   |

Для боковика дополнительно отмечаются “наклоны”:

- **FactMicroUp**: `abs(solFwd1) < minMove && solFwd1 >= 0.1 * minMove`
- **FactMicroDown**: `abs(solFwd1) < minMove && solFwd1 <= -0.1 * minMove`

Это боковики, которыми можно торговать как “почти рост” или “почти обвал”.

---

## 3. Результаты последнего бэктеста

### 3.1. Классификация (строгая)

- **total tested:** 695
- **accuracy:** 54.1%
- **macro F1:** 45.4%
- **micro F1:** 54.1%

| Класс | Support | Precision, % | Recall, % | F1, % |
|-------|---------|--------------|-----------|-------|
| 0 (обвал)  | 151     | 39.0         | 27.2      | 32.0  |
| 1 (боковик)| 381     | 60.9         | 73.5      | 66.6  |
| 2 (рост)   | 163     | 42.3         | 33.7      | 37.5  |

**Выводы:**

- класс **1 (боковик)** — самый частый и самый предсказуемый;
- классы **0 и 2** реже и сложнее: recall примерно **27–34%**;
- **~54% accuracy на 3-классовой задаче** с такой разметкой — это нормальный уровень.

### 3.2. “Мягкая” точность (direction-aware)

В реальной торговле надо считать успехом и такие случаи, как “ожидали рост, а был боковикРост”.

- **lenient acc:** 62.2% (432/695)

То есть при ослабленном сопоставлении (рост ≈ боковикРост, обвал ≈ боковикОбвал) модель уже даёт ≈62%.

### 3.3. Торговля без стоп-лоссов (дневная, `tp-or-close`, 3%)

Режим: берём направленный сигнал, ставим **TP 3%**, если за 24 часа TP задело — фиксируем 3%, иначе закрываемся по цене через 24 часа.

- **Total PnL:** 10 719.9% (≈ ×108.20)
- **Max DD:** 13.9%
- **Trades (opened):** 300
- **tp-hit overall:** 72.3% (217/300)

Это показывает, что модель **правильно указывает сторону**: в ~72% направленных сделок TP за сутки всё-таки случается. Отсутствие стопов раздувает кривую.

---

## 4. Что считается успехом

Нужно явно зафиксировать пары “прогноз → факт”, которые для нас ок:

| Прогноз                          | Факт            | Считаем |
|----------------------------------|-----------------|---------|
| Рост (2)                         | Рост (2)        | ✅       |
| Рост (2)                         | БоковикРост     | ✅       |
| Обвал (0)                        | Обвал (0)       | ✅       |
| Обвал (0)                        | БоковикОбвал    | ✅       |
| Боковик (1) + microUp            | БоковикРост     | ✅       |
| Боковик (1) + microDown          | БоковикОбвал    | ✅       |
| Боковик (1) без микро            | Боковик         | ✅       |
| Рост (2)                         | Боковик         | ⚠️ условно (можно взять по фитилю) |
| Обвал (0)                        | Боковик         | ⚠️ условно |
| Рост (2)                         | БоковикОбвал / Обвал | ❌ |
| Обвал (0)                        | БоковикРост / Рост   | ❌ |

За счёт такой “ослабленной” логики точность и выходит из **~54% → ~62%**.

---

## 5. Почасовые TP/SL

Чтобы сделать проверку более честной, добавлен режим “кто первый внутри дня”. Берутся **1h свечи** и для каждой дневной сделки проверяется:

1. если первой в течение дня коснулась **TP** → успех;
2. если первой коснулась **SL** → провал;
3. если TP и SL внутри одной свечи → **ambiguous**.

Пример результата:

- **tp-first:** 66
- **sl-first:** 131
- **ambiguous (tp & sl in 1h):** 3

То есть как только мы добавляем внутри дня стоп — кривая резко портится, потому что 1h-колебания очень часто выбивают SL раньше, чем цена уйдёт к дневному TP.

---

## 6. Почему так отличается PnL со стопами и без

Сравнение двух режимов:

| Режим                    | PnL                     | Макс. просадка | Сделок  |
|--------------------------|-------------------------|----------------|---------|
| Без SL (`tp-or-close 3%`)| **+10 719.9% (×108.2)** | ~13.9%         | 300     |
| С почасовыми TP/SL       | **+20–21% (×1.2)**      | ~17%           | 58–75   |

Разница не баг, а **разный риск-профиль**:

- дневной режим “мягкий”: TP мог случиться в любой момент суток → мы его засчитываем;
- почасовой режим “жёсткий”: если цена сначала ушла в наш SL — сделка считается плохой, даже если позже за день рынок ушёл бы в нашу сторону.

---

## 7. Как читать метрики

- **accuracy** — ровно угадан ли класс;
- **macro F1** — среднее по трём классам, видно, что боковик тянется лучше;
- **lenient acc** — метрика, которая ближе к реальному трейдингу (считает “рост ≈ боковикРост” и т.п.);
- **tp-hit** — сколько раз за сутки цена успела дать целевые 3%;
- **Total PnL** — модельная доходность, если все сигналы торговать подряд;
- **Max DD** — глубина просадки по этой модельной кривой.

---

## 8. Структура проекта

```text
Core/
  Data/           # загрузка свечей (6h, 1h), F&G, DXY, extra.json
  DataBuilder/    # RowBuilder и сборка дневных строк (DataRow)
  ML/             # ModelTrainer, ModelBundle, PredictionEngine, ML DTO
  Analytics/      # ClassificationMetrics, TradingMetrics
  Trading/        # HourlyTradeEvaluator и почасовая логика TP/SL
  Infra/          # HttpFactory, TimeZones и другие утилиты
  Utils/          # Вывод данных в консоль или другие утилиты
        
Program.cs        # основной rolling-бэктест с выводом в консоль
```   
  
Идея в том, что тяжёлая логика (метрики, трейдинг, сборка строк) вынесена из `Program.cs` в отдельные части проекта.  
Сам `Program.cs` должен быть «тонким» и делать только оркестрацию:
```text
- загрузка данных;
- запуск обучения;
- запуск бэктеста;
- вывод результата в консоль.
```
Это упрощает поддержку: меняем расчёты и метрики — не трогаем точку входа.

---

## 9. Формулы (словами)

### 2.1 Дневной PnL без SL

Логика расчёта доходности по сделке, если мы работаем в режиме “TP за сутки или закрытие по факту”:
- если за 24 часа **high/low** задели TP в сторону позиции →  
  **`ret = TP%`**
- иначе →  
  **`ret = (close24 - entry) / entry`**  
  (для шорта, соответственно, знак меняется)
То есть сначала пытаемся взять целевой ход, и только если рынок его не дал — берем фактический суточный результат.

---

### 2.2 Hourly “кто первый”

Этот режим нужен, чтобы честно понять, что внутри дня произошло раньше — цель или стоп.

Алгоритм:
  1. идём по часовым свечам от `t0` до `t0 + 24h`;
  2. если на одной из свечей `high ≥ tpPrice` → фиксируем **tp-first**;
  3. если `low ≤ slPrice` → фиксируем **sl-first**;
  4. если и TP, и SL внутри одной свечи → помечаем как **ambiguous**.
     
Такой режим обычно ухудшает PnL по сравнению с дневным, потому что внутри часа цена чаще задевает короткий SL раньше, чем уходит в дневной TP.

---

### 2.3 Lenient accuracy

Обычная accuracy слишком строгая для трейдинга, потому что она не считает “рост” и “боковикРост” похожими.

**Lenient accuracy** делает допущение:

- (Рост, БоковикРост) → считаем совпадением;
- (Обвал, БоковикОбвал) → считаем совпадением.

То есть если модель угадала направление, но день вышел с меньшей амплитудой — мы засчитываем успех.

---

## 10. Вывод

- Модель стабильно ловит **боковики** и заметную часть направленных дней.
- При оценке “по направлению” точность выходит примерно **~62%** — за счёт lenient-логики.
- В режиме **без стопов** (`tp-or-close 3%`) получается сильная кривая, потому что в 
большинстве направленных дней рынок отдаёт свои 3% в течение суток.
- В “строгом” режиме с **часовыми SL** итоговый PnL становится более реалистичным и заметно ниже 
— это ожидаемая плата за контроль риска внутри дня.
